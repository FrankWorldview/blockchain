## 📘 Uniswap 大額交易：為什麼不能用「單價 × 數量」？

### 案例設定

- 初始資金池：
  - \( x_0 = 10 \) ETH
  - \( y_0 = 20{,}000 \) USDC
- 常數乘積：\( k = x_0 \cdot y_0 = 200{,}000 \)
- 你想從池中**買入 \( \Delta x = 5 \) ETH**

---

### 問題

你要花多少 USDC 才能從池中買到 5 ETH？價格隨著交易過程會變化，不能用單一價格估算。

---

## ✅ 正確做法：使用積分計算總成本

Uniswap 的定價機制為：

\[
x \cdot y = k \Rightarrow y = \frac{k}{x}
\]

你從池中買入 5 ETH，ETH 數量從 \( x = 10 \) 減少到 \( x = 5 \)。

總成本為：

\[
\text{Total Cost} = \int_{5}^{10} \frac{200{,}000}{x} \, dx
= 200{,}000 \cdot \int_{5}^{10} \frac{1}{x} \, dx
= 200{,}000 \cdot [\ln(10) - \ln(5)]
= 200{,}000 \cdot \ln(2)
\]

查表得：

\[
\ln(2) \approx 0.6931
\]

因此：

\[
\text{Total Cost} \approx 200{,}000 \cdot 0.6931 = 138{,}620 \text{ USDC}
\]

---

## ❌ 錯誤做法：使用固定價格 × 數量

### 方法一：使用初始價格估算

\[
P_0 = \frac{y_0}{x_0} = \frac{20{,}000}{10} = 2{,}000 \text{ USDC / ETH}
\]
\[
\text{Wrong Estimate} = 2{,}000 \times 5 = 10{,}000 \text{ USDC}
\]

這大幅低估了真實成本。

### 方法二：取中間價格估算

\[
x_{\text{mid}} = 7.5, \quad P_{\text{mid}} = \frac{k}{x} = \frac{200{,}000}{7.5} = 26{,}667
\]
\[
\text{Wrong Estimate} = 26{,}667 \times 5 = 133{,}333 \text{ USDC}
\]

這雖然看似接近，但缺乏邏輯依據，不能替代積分。

---

## 📊 成本比較表

| 方法 | 成本（USDC） | 是否正確 | 說明 |
|------|---------------|------------|------|
| 初始價格 × 5 | 10,000 | ❌ | 完全低估，忽略滑價 |
| 中間價格 × 5 | 133,333 | ❌ | 接近但缺乏理論依據 |
| 積分結果 | 138,620 | ✅ | 精準，反映真實滑價過程 |

---

## 🧠 小結

- Uniswap 使用非線性 AMM 機制，價格會隨交易數量而變動。
- Marginal price \( \frac{dy}{dx} \) 僅適用於小額交易。
- 大額交易必須透過積分計算，才能準確反映每一單位價格變化。
- 「單價 × 數量」這種線性邏輯不適用於 AMM。

---

## ✏️ 練習題

1. 如果你只買入 0.01 ETH，為什麼可以用 marginal price 近似估算？
2. 若資金池為 \( x_0 = 100 \)、\( y_0 = 2{,}000 \)，你想買 5 ETH，請重新計算總成本。
3. 請畫出 \( xy = 200{,}000 \) 的曲線，標出從 \( x = 10 \) 到 \( x = 5 \) 的區域，並說明積分區域代表什麼意義。
